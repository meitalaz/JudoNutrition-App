{% extends "athlete_base.html" %}

{% block athlete_content %}
<div class="weight-tracking-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h4 fw-bold text-primary mb-1">מעקב משקל</h2>
            <p class="text-muted small mb-0">עדכון יומי למעקב אחר ההתקדמות</p>
        </div>
        <div class="text-end">
            <div class="fw-bold text-primary fs-5" id="currentWeight">--</div>
            <small class="text-muted">משקל נוכחי</small>
        </div>
    </div>

    <!-- Weight Input Section -->
    <div class="card shadow-sm mb-4" id="weightInputSection">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
                <i class="fas fa-weight me-2"></i>
                רישום משקל חדש
            </h6>
        </div>
        <div class="card-body">
            <form id="weightForm">
                <!-- Weight Input -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label for="weightInput" class="form-label fw-semibold">משקל (ק"ג)</label>
                        <div class="input-group input-group-lg">
                            <input 
                                type="number" 
                                class="form-control form-control-lg text-center fw-bold" 
                                id="weightInput" 
                                inputmode="decimal"
                                step="0.1" 
                                min="40" 
                                max="200"
                                placeholder="0.0"
                                style="font-size: 2rem;"
                                required>
                            <span class="input-group-text bg-primary text-white">ק"ג</span>
                        </div>
                    </div>
                </div>

                <!-- Measurement Time -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label fw-semibold">זמן שקילה</label>
                        <div class="btn-group-vertical d-grid gap-1" role="group">
                            <input type="radio" class="btn-check" name="measurementTime" id="beforeBreakfast" value="לפני ארוחת בוקר">
                            <label class="btn btn-outline-primary text-start" for="beforeBreakfast">
                                <i class="fas fa-sun me-2"></i>לפני ארוחת בוקר
                            </label>
                            
                            <input type="radio" class="btn-check" name="measurementTime" id="afterBreakfast" value="אחרי ארוחת בוקר">
                            <label class="btn btn-outline-primary text-start" for="afterBreakfast">
                                <i class="fas fa-coffee me-2"></i>אחרי ארוחת בוקר
                            </label>
                            
                            <input type="radio" class="btn-check" name="measurementTime" id="lunch" value="סביבות הצהריים">
                            <label class="btn btn-outline-primary text-start" for="lunch">
                                <i class="fas fa-sun me-2"></i>סביבות הצהריים
                            </label>
                            
                            <input type="radio" class="btn-check" name="measurementTime" id="evening" value="בערב">
                            <label class="btn btn-outline-primary text-start" for="evening">
                                <i class="fas fa-moon me-2"></i>בערב
                            </label>
                            
                            <input type="radio" class="btn-check" name="measurementTime" id="custom" value="אחר">
                            <label class="btn btn-outline-primary text-start" for="custom">
                                <i class="fas fa-edit me-2"></i>זמן אחר
                            </label>
                        </div>
                        
                        <!-- Custom time input -->
                        <div class="mt-2" id="customTimeInput" style="display: none;">
                            <input type="text" class="form-control" id="customTime" placeholder="לדוגמה: אחרי אימון...">
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label for="notes" class="form-label fw-semibold">הערות (אופציונלי)</label>
                        <textarea class="form-control" id="notes" rows="2" placeholder="איך את/ה מרגיש/ה, שינויים, הערות..."></textarea>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>
                        שמור משקל
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="fas fa-bullseye me-2"></i>
                התקדמות ליעד
            </h6>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-4">
                    <div class="progress-stat">
                        <div class="h5 fw-bold text-primary mb-1" id="targetWeight">66.0</div>
                        <small class="text-muted">יעד</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="progress-stat">
                        <div class="h5 fw-bold text-success mb-1" id="weightDifference">-2.5</div>
                        <small class="text-muted">נותר</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="progress-stat">
                        <div class="h5 fw-bold text-info mb-1" id="progressPercentage">75%</div>
                        <small class="text-muted">התקדמות</small>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-3">
                <div class="progress" style="height: 12px;">
                    <div class="progress-bar bg-success" id="progressBar" style="width: 75%"></div>
                </div>
            </div>
            
            <!-- Smart Alerts -->
            <div id="smartAlerts" class="mt-3"></div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>
                גרף התקדמות - 14 ימים אחרונים
            </h6>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" id="chart7days">7 ימים</button>
                <button class="btn btn-primary" id="chart14days">14 ימים</button>
                <button class="btn btn-outline-secondary" id="chart30days">30 ימים</button>
            </div>
        </div>
        <div class="card-body">
            <canvas id="weightChart" height="300"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block athlete_scripts %}
<script>
// Weight tracking functionality
let weightChart;
const ATHLETE_ID = 'demo_athlete_1'; // In real app, this would be dynamic

// Initialize weight tracking
document.addEventListener('DOMContentLoaded', function() {
    initializeWeightTracking();
    setupEventListeners();
    loadExistingData();
    createWeightChart();
});

function initializeWeightTracking() {
    console.log('Weight tracking initialized');
    
    // Initialize localStorage if needed
    if (!localStorage.getItem(`weights_${ATHLETE_ID}`)) {
        localStorage.setItem(`weights_${ATHLETE_ID}`, JSON.stringify(generateSampleData()));
    }
    
    updateProgressDisplay();
}

function setupEventListeners() {
    // Custom time radio button
    document.getElementById('custom').addEventListener('change', function() {
        document.getElementById('customTimeInput').style.display = this.checked ? 'block' : 'none';
    });
    
    // Hide custom input when other options selected
    document.querySelectorAll('input[name="measurementTime"]:not(#custom)').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('customTimeInput').style.display = 'none';
        });
    });
    
    // Weight form submission
    document.getElementById('weightForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveWeightEntry();
    });
    
    // Chart period buttons
    document.getElementById('chart7days').addEventListener('click', () => updateChart(7));
    document.getElementById('chart14days').addEventListener('click', () => updateChart(14));
    document.getElementById('chart30days').addEventListener('click', () => updateChart(30));
}

function saveWeightEntry() {
    const weight = parseFloat(document.getElementById('weightInput').value);
    const measurementTime = document.querySelector('input[name="measurementTime"]:checked')?.value;
    const customTime = document.getElementById('customTime').value;
    const notes = document.getElementById('notes').value;
    
    if (!weight || !measurementTime) {
        alert('אנא מלא את כל השדות הנדרשים');
        return;
    }
    
    const entry = {
        weight: weight,
        time: measurementTime === 'אחר' ? customTime : measurementTime,
        notes: notes,
        timestamp: new Date().toISOString(),
        date: new Date().toISOString().split('T')[0]
    };
    
    // Save to localStorage
    const weights = JSON.parse(localStorage.getItem(`weights_${ATHLETE_ID}`) || '[]');
    weights.push(entry);
    localStorage.setItem(`weights_${ATHLETE_ID}`, JSON.stringify(weights));
    
    // Reset form
    document.getElementById('weightForm').reset();
    document.getElementById('customTimeInput').style.display = 'none';
    
    // Update displays
    updateProgressDisplay();
    updateChart(14);
    
    // Show success message
    showSuccessAlert('המשקל נשמר בהצלחה!');
}

function updateProgressDisplay() {
    const weights = JSON.parse(localStorage.getItem(`weights_${ATHLETE_ID}`) || '[]');
    if (weights.length === 0) return;
    
    const latestWeight = weights[weights.length - 1].weight;
    const targetWeight = 66.0; // In real app, this would be from user profile
    
    document.getElementById('currentWeight').textContent = latestWeight.toFixed(1) + ' ק"ג';
    document.getElementById('targetWeight').textContent = targetWeight.toFixed(1);
    
    const difference = latestWeight - targetWeight;
    const differenceEl = document.getElementById('weightDifference');
    differenceEl.textContent = (difference > 0 ? '+' : '') + difference.toFixed(1);
    differenceEl.className = `h5 fw-bold mb-1 ${difference > 0 ? 'text-warning' : 'text-success'}`;
    
    // Calculate progress (assuming starting weight of 72kg)
    const startWeight = 72.0;
    const progress = Math.max(0, Math.min(100, ((startWeight - latestWeight) / (startWeight - targetWeight)) * 100));
    
    document.getElementById('progressPercentage').textContent = Math.round(progress) + '%';
    document.getElementById('progressBar').style.width = progress + '%';
    
    // Generate smart alerts
    generateSmartAlerts(weights, targetWeight);
}

function generateSmartAlerts(weights, targetWeight) {
    const alertsContainer = document.getElementById('smartAlerts');
    alertsContainer.innerHTML = '';
    
    if (weights.length < 2) return;
    
    const latest = weights[weights.length - 1];
    const previous = weights[weights.length - 2];
    const change = latest.weight - previous.weight;
    
    let alertClass = '';
    let alertIcon = '';
    let alertText = '';
    
    if (Math.abs(change) > 1.0) {
        alertClass = 'alert-warning';
        alertIcon = 'fas fa-exclamation-triangle';
        alertText = `שים לב: שינוי משמעותי במשקל (${change > 0 ? '+' : ''}${change.toFixed(1)} ק"ג)`;
    } else if (change > 0.5 && latest.weight > targetWeight) {
        alertClass = 'alert-danger';
        alertIcon = 'fas fa-arrow-up';
        alertText = 'עליה במשקל - כדאי לשקול התאמת התזונה';
    } else if (change < -0.3) {
        alertClass = 'alert-success';
        alertIcon = 'fas fa-arrow-down';
        alertText = 'כל הכבוד! ירידה במשקל - ממשיכים כך!';
    }
    
    if (alertText) {
        alertsContainer.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="${alertIcon} me-2"></i>
                ${alertText}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
}

function createWeightChart() {
    const ctx = document.getElementById('weightChart').getContext('2d');
    const weights = JSON.parse(localStorage.getItem(`weights_${ATHLETE_ID}`) || '[]');
    
    const chartData = prepareChartData(weights, 14);
    
    weightChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'משקל (ק"ג)',
                data: chartData.weights,
                borderColor: '#0077C8',
                backgroundColor: 'rgba(0, 119, 200, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#0077C8',
                pointBorderColor: '#0F4C81',
                pointRadius: 5,
                pointHoverRadius: 8
            }, {
                label: 'יעד',
                data: chartData.targets,
                borderColor: '#FFC20E',
                backgroundColor: 'transparent',
                borderDash: [5, 5],
                pointRadius: 0,
                tension: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 64,
                    max: 74,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + ' ק"ג';
                        }
                    }
                },
                x: {
                    display: true
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

function updateChart(days) {
    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('btn-primary'));
    document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.add('btn-outline-secondary'));
    document.getElementById(`chart${days}days`).classList.remove('btn-outline-secondary');
    document.getElementById(`chart${days}days`).classList.add('btn-primary');
    
    const weights = JSON.parse(localStorage.getItem(`weights_${ATHLETE_ID}`) || '[]');
    const chartData = prepareChartData(weights, days);
    
    weightChart.data.labels = chartData.labels;
    weightChart.data.datasets[0].data = chartData.weights;
    weightChart.data.datasets[1].data = chartData.targets;
    weightChart.update();
}

function prepareChartData(weights, days) {
    const now = new Date();
    const labels = [];
    const weightData = [];
    const targets = [];
    const targetWeight = 66.0;
    
    // Create date range
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        labels.push(date.toLocaleDateString('he-IL', { month: 'short', day: 'numeric' }));
        
        // Find weight for this date
        const dayWeight = weights.find(w => w.date === dateStr);
        weightData.push(dayWeight ? dayWeight.weight : null);
        targets.push(targetWeight);
    }
    
    return { labels, weights: weightData, targets };
}

function generateSampleData() {
    const sampleData = [];
    const now = new Date();
    let weight = 70.5;
    
    for (let i = 13; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        
        // Simulate gradual weight loss
        weight -= Math.random() * 0.3 + 0.1;
        
        sampleData.push({
            weight: Math.round(weight * 10) / 10,
            time: 'לפני ארוחת בוקר',
            notes: '',
            timestamp: date.toISOString(),
            date: date.toISOString().split('T')[0]
        });
    }
    
    return sampleData;
}

function loadExistingData() {
    updateProgressDisplay();
}

function showSuccessAlert(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>

<style>
.weight-tracking-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 0 15px;
}

.progress-stat {
    padding: 10px;
    border-radius: 8px;
    background: rgba(15, 76, 129, 0.05);
}

#weightInput {
    border: 2px solid var(--primary-color);
    border-radius: 12px;
}

#weightInput:focus {
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 0.2rem rgba(0, 119, 200, 0.25);
}

.btn-check:checked + .btn {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

#weightChart {
    height: 300px !important;
}

.alert {
    border-radius: 10px;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
</style>
{% endblock %}